<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(content=~{::main}, title='Promotions')}">

<main th:fragment="main">

    <nav aria-label="breadcrumb" class="mb-4 text-sm">
        <ol class="flex flex-wrap items-center gap-x-2 text-slate-600">
            <li><a th:href="@{/admin}" class="hover:text-slate-900 hover:underline">Admin</a></li>
            <li class="text-slate-400">/</li>
            <li class="font-semibold text-slate-900">Promotions</li>
        </ol>
    </nav>

    <div class="mb-4">
        <h1 class="text-xl font-semibold">Promotion Wizard</h1>
        <p class="text-sm text-slate-500">Preview puis Commit du passage des étudiants.</p>
    </div>

    <!-- FILTER / PREVIEW -->
    <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
        <form th:action="@{/admin/promotions}" method="get" class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="text-xs text-slate-500">From Year</label>
                <input name="fromYear" type="number" th:value="${fromYear}" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm"/>
            </div>
            <div>
                <label class="text-xs text-slate-500">To Year</label>
                <input name="toYear" type="number" th:value="${toYear}" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm"/>
            </div>
            <div>
                <label class="text-xs text-slate-500">From Level</label>
                <select name="fromLevelId" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm bg-white">
                    <option value="">--</option>
                    <option th:each="l : ${levels}"
                            th:value="${l.id}"
                            th:text="${l.label != null ? l.label : l.code}"
                            th:selected="${l.id == fromLevelId}">
                    </option>
                </select>
            </div>
            <div>
                <label class="text-xs text-slate-500">To Level</label>
                <select name="toLevelId" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm bg-white">
                    <option value="">--</option>
                    <option th:each="l : ${levels}"
                            th:value="${l.id}"
                            th:text="${l.label != null ? l.label : l.code}"
                            th:selected="${l.id == toLevelId}">
                    </option>
                </select>
            </div>

            <div class="md:col-span-4 flex justify-end">
                <button class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                    Preview
                </button>
            </div>
        </form>
    </div>

    <!-- PREVIEW TABLE + COMMIT -->
    <div class="mt-6 rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden"
         th:if="${preview != null}">
        <div class="border-b border-slate-200 px-4 py-3 font-semibold flex items-center justify-between">
            <span>Preview</span>
            <span class="text-xs text-slate-500" th:text="${#lists.size(preview)} + ' students'"></span>
        </div>

        <form th:action="@{/admin/promotions/commit}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="fromYear" th:value="${fromYear}"/>
            <input type="hidden" name="toYear" th:value="${toYear}"/>
            <input type="hidden" name="fromLevelId" th:value="${fromLevelId}"/>
            <input type="hidden" name="toLevelId" th:value="${toLevelId}"/>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 text-left text-slate-600">
                    <tr>
                        <th class="px-4 py-3">Student</th>
                        <th class="px-4 py-3">Decision</th>
                        <th class="px-4 py-3">Action</th>
                        <th class="px-4 py-3">From Group</th>
                        <th class="px-4 py-3">To Group</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="line, it : ${preview}" class="border-t hover:bg-slate-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-slate-900" th:text="${line.fullName}"></div>
                            <div class="text-xs text-slate-500" th:text="${line.studentId}"></div>

                            <input type="hidden" name="studentId" th:value="${line.studentId}"/>
                        </td>

                        <td class="px-4 py-3" th:text="${line.decision}"></td>

                        <td class="px-4 py-3">
                            <select name="action" class="rounded-lg border px-3 py-2 text-sm bg-white">
                                <option th:selected="${line.action == 'PROMOTE'}" value="PROMOTE">PROMOTE</option>
                                <option th:selected="${line.action == 'REPEAT'}" value="REPEAT">REPEAT</option>
                                <option th:selected="${line.action == 'HOLD'}" value="HOLD">HOLD</option>
                                <option th:selected="${line.action == 'DROP'}" value="DROP">DROP</option>
                                <option th:selected="${line.action == 'GRADUATE'}" value="GRADUATE">GRADUATE</option>
                            </select>
                        </td>

                        <td class="px-4 py-3 text-slate-700" th:text="${line.fromClassGroupId}"></td>

                        <td class="px-4 py-3">
                            <select name="toClassGroupId" class="w-full rounded-lg border px-3 py-2 text-sm bg-white">
                                <option value="">-- choose --</option>
                                <option th:each="cg : ${classGroups}"
                                        th:value="${cg.id}"
                                        th:text="${cg.label != null ? cg.label : cg.code}">
                                </option>
                            </select>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(preview)}">
                        <td colspan="5" class="px-4 py-6 text-center text-slate-500">Aucun étudiant à promouvoir.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-2 border-t border-slate-200 px-4 py-4">
                <button class="rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700"
                        onclick="return confirm('Confirmer le commit ? Cette action crée les enrollments N+1 et clôture N.');">
                    Commit
                </button>
            </div>
        </form>
    </div>

</main>
</html>
